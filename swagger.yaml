openapi: 3.0.3
info:
  title: Media Tracking API
  description: API for managing user watchlists, favorites, watched content, and profile avatars
  version: 1.0.0
  contact:
    name: API Support

servers:
  - url: https://pibble-user-db.onrender.com/
    description: Production server
  - url: http://localhost:3000
    description: Development server

tags:
  - name: Watchlist
    description: Operations related to user watchlists
  - name: Favorites
    description: Operations related to user favorites
  - name: Watched
    description: Operations related to watched content
  - name: Avatar
    description: Operations related to user profile avatars

paths:
  /{userid}/watchlist:
    get:
      tags:
        - Watchlist
      summary: Get all watchlist items for a user
      description: Retrieves all movies and TV shows in the user's watchlist
      operationId: getUserWatchlist
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      responses:
        '200':
          description: Successfully retrieved watchlist items
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MediaItem'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      tags:
        - Watchlist
      summary: Add item to watchlist
      description: Adds a new movie or TV show to the user's watchlist
      operationId: addToWatchlist
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MediaItemInput'
      responses:
        '201':
          description: Item successfully added to watchlist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MediaItem'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      tags:
        - Watchlist
      summary: Delete all watchlist items
      description: Removes all items from the user's watchlist
      operationId: deleteAllWatchlist
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      responses:
        '204':
          description: All watchlist items successfully deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{userid}/watchlist/{mediaid}:
    delete:
      tags:
        - Watchlist
      summary: Delete single watchlist item
      description: Removes a specific item from the user's watchlist
      operationId: deleteWatchlistItem
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
        - $ref: '#/components/parameters/MediaIdParam'
      responses:
        '204':
          description: Watchlist item successfully deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{userid}/favorites:
    get:
      tags:
        - Favorites
      summary: Get all favorites for a user
      description: Retrieves all movies and TV shows in the user's favorites
      operationId: getUserFavorites
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      responses:
        '200':
          description: Successfully retrieved favorites
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MediaItem'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      tags:
        - Favorites
      summary: Add item to favorites
      description: Adds a new movie or TV show to the user's favorites
      operationId: addToFavorites
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MediaItemInput'
      responses:
        '201':
          description: Item successfully added to favorites
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MediaItem'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      tags:
        - Favorites
      summary: Delete all favorites
      description: Removes all items from the user's favorites
      operationId: deleteAllFavorites
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      responses:
        '204':
          description: All favorites successfully deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{userid}/favorites/{mediaid}:
    delete:
      tags:
        - Favorites
      summary: Delete single favorite item
      description: Removes a specific item from the user's favorites
      operationId: deleteFavoriteItem
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
        - $ref: '#/components/parameters/MediaIdParam'
      responses:
        '204':
          description: Favorite item successfully deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{userid}/watched:
    get:
      tags:
        - Watched
      summary: Get all watched items for a user
      description: Retrieves all movies and TV shows the user has watched
      operationId: getUserWatched
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      responses:
        '200':
          description: Successfully retrieved watched items
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MediaItem'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    post:
      tags:
        - Watched
      summary: Add item to watched history
      description: Adds a new movie or TV show to the user's watched history
      operationId: addToWatched
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MediaItemInput'
      responses:
        '201':
          description: Item successfully added to watched history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MediaItem'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalServerError'
    delete:
      tags:
        - Watched
      summary: Delete all watched items
      description: Removes all items from the user's watched history
      operationId: deleteAllWatched
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      responses:
        '204':
          description: All watched items successfully deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{userid}/watched/{mediaid}:
    delete:
      tags:
        - Watched
      summary: Delete single watched item
      description: Removes a specific item from the user's watched history
      operationId: deleteWatchedItem
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
        - $ref: '#/components/parameters/MediaIdParam'
      responses:
        '204':
          description: Watched item successfully deleted
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /avatar/all:
    get:
      tags:
        - Avatar
      summary: Get all available avatars
      description: |
        Retrieves all 7 predefined profile picture options available for users to choose from.

        **Avatar System:**
        - 7 predefined avatars (IDs 1-7)
        - Avatar #1 (Avatar 0 Smile) is the default
        - No authentication required
        - Returns avatars ordered by avatar_id

        **Use Case:**
        Display these avatars in an avatar picker UI to allow users to select their profile picture.
      operationId: getAllAvatars
      security: []  # No authentication required
      responses:
        '200':
          description: Successfully retrieved all 7 avatars
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Avatar'
              example:
                - avatar_id: 1
                  avatar_name: Avatar 0 Smile
                  avatar_url: https://occ-0-3945-2567-1.../avatar0.png
                  is_default: true
                - avatar_id: 2
                  avatar_name: Avatar 1 Bird
                  avatar_url: https://occ-0-3933-116-1.../avatar1.png
                  is_default: false
                - avatar_id: 3
                  avatar_name: Avatar 2 Girl
                  avatar_url: https://occ-0-2705-2705-1.../avatar2.png
                  is_default: false
                - avatar_id: 4
                  avatar_name: Avatar 3 Dog
                  avatar_url: https://occ-0-33-37-1.../avatar3.png
                  is_default: false
                - avatar_id: 5
                  avatar_name: Avatar 4 Rhino
                  avatar_url: https://occ-0-3945-2567-1.../avatar4.png
                  is_default: false
                - avatar_id: 6
                  avatar_name: Avatar 5 Sheep
                  avatar_url: https://occ-0-3933-116-1.../avatar5.png
                  is_default: false
                - avatar_id: 7
                  avatar_name: Avatar 6 T-Rex
                  avatar_url: https://occ-0-3933-116-1.../avatar6.png
                  is_default: false
        '500':
          $ref: '#/components/responses/InternalServerError'

  /{userid}/avatar:
    get:
      tags:
        - Avatar
      summary: Get user's current avatar
      description: |
        Retrieves the profile picture currently assigned to the user.

        **Behavior:**
        - If user has selected an avatar → returns their selected avatar (IDs 1-7)
        - If user has NOT selected an avatar → returns default avatar (avatar_id: 1)

        **Authentication:**
        - Requires valid JWT token
        - Users can only access their own avatar

        **Use Case:**
        - Display user's avatar in navigation bar, profile page, etc.
        - Highlight current selection in avatar picker
      operationId: getUserAvatar
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      responses:
        '200':
          description: Successfully retrieved user's avatar
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Avatar'
              examples:
                selectedAvatar:
                  summary: User has selected an avatar
                  value:
                    avatar_id: 3
                    avatar_name: Avatar 2 Girl
                    avatar_url: https://occ-0-2705-2705-1.../avatar2.png
                defaultAvatar:
                  summary: User hasn't selected (gets default)
                  value:
                    avatar_id: 1
                    avatar_name: Avatar 0 Smile
                    avatar_url: https://occ-0-3945-2567-1.../avatar0.png
                    is_default: true
        '401':
          description: Unauthorized - Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Authentication required
                code: UNAUTHORIZED
        '403':
          description: Forbidden - Accessing another user's avatar
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: You can only access your own avatar
                code: FORBIDDEN
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
    patch:
      tags:
        - Avatar
      summary: Update user's avatar
      description: |
        Changes the profile picture assigned to the user by selecting from one of the 7 predefined avatars.

        **Valid Avatar IDs:** 1, 2, 3, 4, 5, 6, 7

        **Validation:**
        - avatar_id must be a number between 1 and 7
        - avatar_id must exist in the avatars table
        - Returns 400 error if invalid

        **Rate Limiting:**
        - STRICT: 10 requests per hour
        - Prevents abuse of avatar changes
        - Returns 429 error if exceeded

        **Authentication:**
        - Requires valid JWT token
        - Users can only update their own avatar

        **Use Case:**
        User selects a different avatar from the avatar picker UI.
      operationId: updateUserAvatar
      security:
        - BearerAuth: []
      parameters:
        - $ref: '#/components/parameters/UserIdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AvatarUpdate'
            examples:
              updateToAvatar5:
                summary: Change to Avatar 4 Rhino
                value:
                  avatar_id: 5
              updateToDefault:
                summary: Change back to default avatar
                value:
                  avatar_id: 1
      responses:
        '200':
          description: Avatar successfully updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Avatar'
              example:
                avatar_id: 5
                avatar_name: Avatar 4 Rhino
                avatar_url: https://occ-0-3945-2567-1.../avatar4.png
        '400':
          description: Bad Request - Invalid avatar_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidId:
                  summary: Avatar ID out of range
                  value:
                    error: Avatar ID must be between 1 and 7
                    code: VALIDATION_ERROR
                    timestamp: '2025-11-29T12:00:00.000Z'
                notANumber:
                  summary: Avatar ID not a number
                  value:
                    error: avatar_id must be a valid number
                    code: VALIDATION_ERROR
                    timestamp: '2025-11-29T12:00:00.000Z'
        '401':
          description: Unauthorized - Missing or invalid token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Authentication required
                code: UNAUTHORIZED
        '403':
          description: Forbidden - Updating another user's avatar
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: You can only update your own avatar
                code: FORBIDDEN
        '404':
          description: Avatar not found in database
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Avatar not found
                code: NOT_FOUND
        '429':
          description: Rate limit exceeded (max 10 per hour)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Too many avatar changes. Please try again later.
                code: RATE_LIMIT_EXCEEDED
                timestamp: '2025-11-29T12:00:00.000Z'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  parameters:
    UserIdParam:
      name: userid
      in: path
      description: Unique identifier for the user
      required: true
      schema:
        type: integer
        format: int64
        example: 456

    MediaIdParam:
      name: mediaid
      in: path
      description: Unique identifier for the media item
      required: true
      schema:
        type: string
        example: tt9876543

  schemas:
    MediaItem:
      type: object
      properties:
        id:
          type: string
          description: UUID of the record
          example: 93e5db8c-78d2-4153-845d-0a4a373b...
        source_text:
          type: string
          description: Source category (watchlist, favorites, watched)
          enum:
            - watchlist
            - favorites
            - watched
          example: watchlist
        user_id:
          type: integer
          format: int64
          description: ID of the user who owns this entry
          example: 456
        media_type:
          type: string
          description: Type of media content
          enum:
            - movie
            - tvshow
          example: movie
        media_id:
          type: string
          description: ID of the movie or TV show
          example: tt9876543
        added_at:
          type: string
          format: date-time
          description: Timestamp when the item was added
          example: '2025-11-26T21:07:08.130009Z'
      required:
        - id
        - source_text
        - user_id
        - media_type
        - media_id
        - added_at

    MediaItemInput:
      type: object
      properties:
        media_type:
          type: string
          description: Type of media content
          enum:
            - movie
            - tvshow
          example: movie
        media_id:
          type: string
          description: ID of the movie or TV show from the database
          example: tt9876543
      required:
        - media_type
        - media_id

    Avatar:
      type: object
      description: Represents one of the 7 predefined avatar options available for users
      properties:
        avatar_id:
          type: integer
          format: int64
          description: |
            Unique identifier for the avatar.
            Valid values: 1, 2, 3, 4, 5, 6, 7
            - Avatar 1 (Avatar 0 Smile) is the default
          minimum: 1
          maximum: 7
          example: 1
        avatar_name:
          type: string
          description: |
            Display name for the avatar.
            Examples: "Avatar 0 Smile", "Avatar 1 Bird", "Avatar 2 Girl", etc.
          example: Avatar 0 Smile
        avatar_url:
          type: string
          format: uri
          description: |
            URL or path to the avatar image.
            Can be an absolute URL or a relative path.
          example: https://occ-0-3945-2567-1.../avatar0.png
        is_default:
          type: boolean
          description: |
            Indicates if this is the default avatar.
            Only avatar_id 1 has this set to true.
            This field is only returned in GET /avatar/all and when user has no avatar selected.
          example: true
      required:
        - avatar_id
        - avatar_name
        - avatar_url

    AvatarUpdate:
      type: object
      description: Request body for updating a user's avatar selection
      properties:
        avatar_id:
          type: integer
          format: int64
          description: |
            ID of the avatar to assign to the user.
            Must be between 1 and 7 (one of the predefined avatars).

            Available avatars:
            - 1: Avatar 0 Smile (default)
            - 2: Avatar 1 Bird
            - 3: Avatar 2 Girl
            - 4: Avatar 3 Dog
            - 5: Avatar 4 Rhino
            - 6: Avatar 5 Sheep
            - 7: Avatar 6 T-Rex
          minimum: 1
          maximum: 7
          example: 3
      required:
        - avatar_id

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
          example: Resource not found
        code:
          type: string
          description: Error code
          example: NOT_FOUND
        timestamp:
          type: string
          format: date-time
          description: When the error occurred
          example: '2025-11-26T21:07:08.130009Z'
      required:
        - error

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Invalid media_type. Must be 'movie' or 'tvshow'
            code: BAD_REQUEST

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: User or resource not found
            code: NOT_FOUND

    Conflict:
      description: Resource already exists
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: Item already exists in watchlist
            code: CONFLICT

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: An unexpected error occurred
            code: INTERNAL_SERVER_ERROR

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token-based authentication

    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key authentication

security:
  - BearerAuth: []
  - ApiKeyAuth: []